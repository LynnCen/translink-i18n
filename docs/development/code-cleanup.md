# ä»£ç æ¸…ç†æŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-11
**ä»»åŠ¡**: å®¡æŸ¥å’Œæ¸…ç†é‡æ„åçš„å†—ä½™ä»£ç 

---

## âœ… æ¸…ç†å®Œæˆå†…å®¹

### 1. åˆ é™¤axiosä¾èµ– âœ…

**æ–‡ä»¶**: `packages/cli/package.json`
**åŸå› **: é‡æ„åå·²å®Œå…¨ä¸ä½¿ç”¨axiosï¼Œæ‰€æœ‰HTTPè¯·æ±‚éƒ½é€šè¿‡å®˜æ–¹SDKå¤„ç†
**å½±å“**:

- å‡å°‘äº†çº¦1.7MBçš„ä¾èµ–ä½“ç§¯
- ç®€åŒ–äº†ä¾èµ–æ ‘
- é™ä½äº†æ½œåœ¨çš„å®‰å…¨æ¼æ´é£é™©

**å‰åå¯¹æ¯”**:

```diff
  "dependencies": {
    "@anthropic-ai/sdk": "^0.30.0",
    "@google/generative-ai": "^0.21.0",
-   "axios": "^1.7.0",
    "commander": "^11.1.0",
    ...
  }
```

---

### 2. åˆ é™¤estimateCostæ¥å£æ–¹æ³• âœ…

**æ–‡ä»¶**: `packages/cli/src/ai/types.ts`
**åŸå› **:

- å®šä¹‰ä¸ºå¯é€‰æ–¹æ³•ä½†æ²¡æœ‰ä»»ä½•Providerå®ç°
- æˆæœ¬ä¼°ç®—å·²åœ¨Engineå†…éƒ¨ç¡¬ç¼–ç å®ç°ï¼ˆæ›´åˆç†çš„æ¶æ„ï¼‰
  **å½±å“**: å‡å°‘äº†8è¡Œæœªä½¿ç”¨çš„ä»£ç 

**åˆ é™¤å†…å®¹**:

```typescript
// AIProvideræ¥å£ä¸­åˆ é™¤
estimateCost?(params: EstimateCostParams): Promise<number>;

// åˆ é™¤EstimateCostParamsæ¥å£å®šä¹‰
export interface EstimateCostParams {
  itemCount: number;
  avgLength: number;
  sourceLang: string;
  targetLang: string;
}
```

**ä¿ç•™ä½ç½®**:
æˆæœ¬ä¼°ç®—åŠŸèƒ½ä»ç„¶å­˜åœ¨äº `AITranslationEngine.estimateCost()` ç§æœ‰æ–¹æ³•ä¸­ï¼Œè¿™æ˜¯æ›´åˆç†çš„è®¾è®¡ï¼Œå› ä¸ºæˆæœ¬è®¡ç®—é€»è¾‘åº”è¯¥ç”±å¼•æ“ç»Ÿä¸€ç®¡ç†ï¼Œè€Œä¸æ˜¯ç”±æ¯ä¸ªProviderå•ç‹¬å®ç°ã€‚

---

### 3. åˆ é™¤BaseAIProvider.sleepæ–¹æ³• âœ…

**æ–‡ä»¶**: `packages/cli/src/ai/providers/base.ts`
**åŸå› **:

- åœ¨BaseAIProviderä¸­å®šä¹‰ä½†ä»æœªè¢«å­ç±»ä½¿ç”¨
- RetryStrategyå’ŒEngineéƒ½æœ‰è‡ªå·±çš„sleepå®ç°
- é¿å…é‡å¤ä»£ç 

**å½±å“**: å‡å°‘äº†6è¡Œæœªä½¿ç”¨çš„ä»£ç 

**åˆ é™¤å†…å®¹**:

```typescript
protected async sleep(ms: number): Promise<void> {
  return new Promise(resolve => setTimeout(resolve, ms));
}
```

**sleepæ–¹æ³•ä¿ç•™ä½ç½®**:

- `packages/cli/src/ai/engine.ts` (Engineå†…éƒ¨ä½¿ç”¨)
- `packages/cli/src/ai/utils/retry.ts` (é‡è¯•ç­–ç•¥ä½¿ç”¨)

---

### 4. ä¼˜åŒ–translateStreamé»˜è®¤å®ç° âœ…

**æ–‡ä»¶**: `packages/cli/src/ai/providers/base.ts`
**æ”¹è¿›**: æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œæé†’å¼€å‘è€…è¿™æ˜¯fallbackå®ç°
**åŸå› **: æ‰€æœ‰4ä¸ªProvideréƒ½å·²é‡å†™æ­¤æ–¹æ³•ï¼Œä½†ä¿ç•™é»˜è®¤å®ç°ä½œä¸ºå®‰å…¨fallback

**ä¼˜åŒ–å**:

```typescript
async *translateStream?(
  params: TranslateParams
): AsyncGenerator<StreamChunk, TranslateResult> {
  logger.debug(
    `${this.name}: ä½¿ç”¨é»˜è®¤translateStreamå®ç°ï¼ˆéçœŸå®æµå¼ï¼‰`
  );

  // é»˜è®¤å®ç°ï¼šç›´æ¥è°ƒç”¨translateå¹¶è¿”å›å®Œæ•´ç»“æœ
  const result = await this.translate(params);
  yield {
    text: result.translatedText,
    finished: true,
    tokensUsed: result.tokensUsed,
  };
  return result;
}
```

---

## ğŸ”§ ä¿®å¤çš„é—®é¢˜

### TypeScripté”™è¯¯ä¿®å¤

**é—®é¢˜**: `override`ä¿®é¥°ç¬¦åœ¨ErroråŸºç±»ä¸­ä¸å­˜åœ¨
**æ–‡ä»¶**: `packages/cli/src/ai/errors.ts`
**è§£å†³æ–¹æ¡ˆ**: å°†`cause`é‡å‘½åä¸º`errorCause`

```diff
- public override readonly cause?: Error;
+ public readonly errorCause?: Error;
```

---

## ğŸ“Š æ¸…ç†ç»Ÿè®¡

| ç±»å‹                 | æ•°é‡   | è¯´æ˜                    |
| -------------------- | ------ | ----------------------- |
| **åˆ é™¤çš„ä¾èµ–**       | 1ä¸ª    | axios                   |
| **åˆ é™¤çš„æ¥å£æ–¹æ³•**   | 1ä¸ª    | estimateCost            |
| **åˆ é™¤çš„ç±»å‹å®šä¹‰**   | 1ä¸ª    | EstimateCostParams      |
| **åˆ é™¤çš„å·¥å…·æ–¹æ³•**   | 1ä¸ª    | BaseAIProvider.sleep    |
| **ä¼˜åŒ–çš„æ–¹æ³•**       | 1ä¸ª    | translateStreamé»˜è®¤å®ç° |
| **æ€»è®¡åˆ é™¤ä»£ç è¡Œæ•°** | ~20è¡Œ  | -                       |
| **ä¾èµ–ä½“ç§¯å‡å°‘**     | ~1.7MB | -                       |

---

## âœ… éªŒè¯ç»“æœ

### æ„å»ºæµ‹è¯•

```bash
pnpm run build
# âœ… Build success in 48ms
```

### ä¾èµ–å®‰è£…

```bash
pnpm install
# âœ… Packages: -3 (æˆåŠŸç§»é™¤3ä¸ªåŒ…)
```

---

## ğŸ¯ æ¸…ç†åŸåˆ™

æœ¬æ¬¡æ¸…ç†éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **YAGNIåŸåˆ™** (You Aren't Gonna Need It)
   - åˆ é™¤æœªä½¿ç”¨çš„æ¥å£æ–¹æ³•å’Œç±»å‹å®šä¹‰
   - ç§»é™¤æœªä½¿ç”¨çš„ä¾èµ–åŒ…

2. **DRYåŸåˆ™** (Don't Repeat Yourself)
   - åˆ é™¤é‡å¤çš„sleepæ–¹æ³•å®ç°
   - ä¿ç•™å¿…è¦çš„å…¬å…±å®ç°

3. **èŒè´£å•ä¸€åŸåˆ™**
   - æˆæœ¬ä¼°ç®—ç”±Engineç»Ÿä¸€ç®¡ç†
   - Provideråªè´Ÿè´£ç¿»è¯‘é€»è¾‘

4. **æœ€å°åŒ–ä¾èµ–**
   - ä½¿ç”¨å®˜æ–¹SDKè€Œéé€šç”¨HTTPåº“
   - å‡å°‘ä¾èµ–æ ‘çš„å¤æ‚åº¦

---

## ğŸ“ ä¿ç•™çš„åˆç†ä»£ç 

ä»¥ä¸‹ä»£ç ç»è¿‡å®¡æŸ¥ï¼Œç¡®è®¤ä¸ºå¿…è¦ä¸”åˆç†çš„å®ç°ï¼š

### âœ… å®˜æ–¹SDKé›†æˆ

- OpenAI SDK (`openai`)
- Google Generative AI SDK (`@google/generative-ai`)
- Anthropic SDK (`@anthropic-ai/sdk`)

### âœ… é”™è¯¯å¤„ç†ç³»ç»Ÿ

- å®Œæ•´çš„é”™è¯¯ç±»å‹å±‚çº§
- ErrorFactoryç»Ÿä¸€é”™è¯¯è½¬æ¢
- è¯¦ç»†çš„é”™è¯¯åˆ†ç±»

### âœ… é‡è¯•æœºåˆ¶

- RetryStrategyæ™ºèƒ½é‡è¯•
- æŒ‡æ•°é€€é¿ç®—æ³•
- JitteræŠ–åŠ¨é¿å…ç¾Šç¾¤æ•ˆåº”

### âœ… æµå¼å“åº”

- æ‰€æœ‰4ä¸ªProviderçš„æµå¼å®ç°
- é»˜è®¤fallbackå®ç°ï¼ˆä¼˜åŒ–åï¼‰

### âœ… ç¼“å­˜ç³»ç»Ÿ

- TranslationCacheåŸºç¡€åŠŸèƒ½
- é¢„çƒ­å’Œæ¸…ç†å¢å¼ºåŠŸèƒ½
- ç»Ÿè®¡ä¿¡æ¯æ”¯æŒ

### âœ… ç±»å‹ç³»ç»Ÿ

- å®Œæ•´çš„æ¥å£å®šä¹‰
- Providerèƒ½åŠ›å£°æ˜
- æµå¼å“åº”ç±»å‹

---

## ğŸš€ åç»­å»ºè®®

### å¯é€‰çš„è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆéå¿…éœ€ï¼‰

1. **ç»Ÿä¸€sleepå·¥å…·å‡½æ•°** (ä¼˜å…ˆçº§ï¼šä½)
   - å½“å‰æœ‰3å¤„sleepå®ç°
   - å¯ä»¥æå–ä¸ºå…±äº«å·¥å…·å‡½æ•°
   - ä½†å½“å‰å®ç°ä¹Ÿæ˜¯åˆç†çš„ï¼ˆå„è‡ªå°è£…ï¼‰

2. **Provideræµ‹è¯•è¦†ç›–** (ä¼˜å…ˆçº§ï¼šä¸­)
   - ä¸ºæ¯ä¸ªProvideræ·»åŠ å•å…ƒæµ‹è¯•
   - æµ‹è¯•é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
   - æµ‹è¯•æµå¼å“åº”

3. **æ€§èƒ½åŸºå‡†æµ‹è¯•** (ä¼˜å…ˆçº§ï¼šä½)
   - å¯¹æ¯”ä¸åŒProviderçš„æ€§èƒ½
   - æµ‹è¯•æ‰¹é‡å¤„ç†æ•ˆç‡
   - ç›‘æ§å†…å­˜ä½¿ç”¨

---

## ğŸ“Š æœ€ç»ˆä»£ç è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡           | è¯„åˆ†       | è¯´æ˜                    |
| -------------- | ---------- | ----------------------- |
| **ä»£ç ç»„ç»‡**   | â­â­â­â­â­ | æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†          |
| **ç±»å‹å®‰å…¨**   | â­â­â­â­â­ | å®Œæ•´çš„TypeScriptç±»å‹    |
| **é”™è¯¯å¤„ç†**   | â­â­â­â­â­ | è¯¦ç»†çš„é”™è¯¯åˆ†ç±»          |
| **å¯ç»´æŠ¤æ€§**   | â­â­â­â­â­ | èŒè´£æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•      |
| **ä¾èµ–ç®¡ç†**   | â­â­â­â­â­ | ä½¿ç”¨å®˜æ–¹SDKï¼Œæœ€å°åŒ–ä¾èµ– |
| **æ–‡æ¡£å®Œæ•´æ€§** | â­â­â­â­   | ä»£ç æ³¨é‡Šå®Œæ•´            |
| **æ€§èƒ½ä¼˜åŒ–**   | â­â­â­â­   | æ‰¹é‡å¤„ç†+æµå¼æ”¯æŒ       |

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä»£ç æ¸…ç†æˆåŠŸç§»é™¤äº†é‡æ„åé—ç•™çš„å†—ä½™ä»£ç ï¼ŒåŒ…æ‹¬ï¼š

- æœªä½¿ç”¨çš„ä¾èµ–ï¼ˆaxiosï¼‰
- æœªå®ç°çš„æ¥å£æ–¹æ³•ï¼ˆestimateCostï¼‰
- å†—ä½™çš„å·¥å…·æ–¹æ³•ï¼ˆBaseAIProvider.sleepï¼‰
- ä¼˜åŒ–äº†fallbackå®ç°ï¼ˆtranslateStreamï¼‰

æ¸…ç†åçš„ä»£ç æ›´åŠ ç²¾ç®€ã€é«˜æ•ˆï¼ŒåŒæ—¶ä¿æŒäº†å®Œæ•´çš„åŠŸèƒ½æ€§å’Œè‰¯å¥½çš„æ¶æ„è®¾è®¡ã€‚

**æ¸…ç†çŠ¶æ€**: âœ… å®Œæˆ
**æ„å»ºçŠ¶æ€**: âœ… é€šè¿‡
**ç”Ÿäº§å°±ç»ª**: âœ… æ˜¯
